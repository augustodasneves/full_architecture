services:
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password
      POSTGRES_DB: userdb
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - app-network

  redis:
    image: redis:alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - app-network

  mongodb:
    image: mongo:7-jammy
    container_name: mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password123
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - app-network

  servicebus-emulator:
    image: mcr.microsoft.com/azure-messaging/servicebus-emulator:latest
    container_name: servicebus-emulator
    environment:
      ACCEPT_EULA: "Y"
      SQL_SERVER: "sql-edge"
      MSSQL_SA_PASSWORD: "StrongPassword123!"
    ports:
      - "5672:5672"
    volumes:
      - ./src/ServiceBusConfig.json:/ServiceBus_Emulator/ConfigFiles/Config.json
    depends_on:
      - sql-edge
    networks:
      - app-network

  sql-edge:
    image: mcr.microsoft.com/azure-sql-edge:latest
    container_name: sql-edge
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "StrongPassword123!"
    ports:
      - "1433:1433"
    networks:
      - app-network

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
      - ./scripts/init-ollama.sh:/init-ollama.sh
    networks:
      - app-network
    entrypoint: [ "/bin/sh", "-c" ]
    command: >
      "ollama serve &  sleep 5 &&  ollama pull phi3 &&  wait"

  user-account-api:
    image: ${DOCKER_REGISTRY-}useraccountapi
    build:
      context: .
      dockerfile: src/UserAccountApi/Dockerfile
    environment:
      - ConnectionStrings__DefaultConnection=Host=postgres;Database=userdb;Username=admin;Password=password
    ports:
      - "8080:8080"
    depends_on:
      - postgres
    networks:
      - app-network

  ai-chat-service:
    image: ${DOCKER_REGISTRY-}aichatservice
    build:
      context: .
      dockerfile: src/AIChatService/Dockerfile
    environment:
      - ConnectionStrings__Redis=redis:6379
      - MongoDB__ConnectionString=mongodb://admin:password123@mongodb:27017
      - MongoDB__DatabaseName=whatsapp_flows
      - Anonymization__SaltKey=change-this-in-production-12345
      - ServiceBus__ConnectionString=Endpoint=sb://servicebus-emulator;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=SAS_KEY_VALUE;UseDevelopmentEmulator=true;
      - LLM__BaseUrl=http://ollama:11434
      - WhatsAppProxy__BaseUrl=http://whatsapp-proxy-api:8080
      - UserAccountApi__BaseUrl=http://user-account-api:8080
    ports:
      - "8081:8080"
    depends_on:
      - redis
      - mongodb
      - servicebus-emulator
      - ollama
      - whatsapp-proxy-api
      - user-account-api
    networks:
      - app-network

  baileys-whatsapp-service:
    image: ${DOCKER_REGISTRY-}baileyswhatsappservice
    build:
      context: ./src/BaileysWhatsAppService
      dockerfile: Dockerfile
    environment:
      - WEBHOOK_URL=http://ai-chat-service:8080/api/whatsapp/webhook
    ports:
      - "3000:3000"
    volumes:
      - baileys_auth:/app/auth_info
      - ./src/BaileysWhatsAppService/baileys_store.json:/app/baileys_store.json
    networks:
      - app-network

  whatsapp-proxy-api:
    image: ${DOCKER_REGISTRY-}whatsappproxyapi
    build:
      context: .
      dockerfile: src/WhatsAppProxyApi/Dockerfile
    environment:
      - WhatsApp__BaileysServiceUrl=http://baileys-whatsapp-service:3000
      - WhatsApp__VerifyToken=${WHATSAPP_VERIFY_TOKEN:-testes}
    ports:
      - "8082:8080"
    depends_on:
      - baileys-whatsapp-service
    networks:
      - app-network

  pii-update-worker:
    image: ${DOCKER_REGISTRY-}piiupdateworker
    build:
      context: .
      dockerfile: src/PiiUpdateWorker/Dockerfile
    environment:
      - ServiceBus__ConnectionString=Endpoint=sb://servicebus-emulator;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=SAS_KEY_VALUE;UseDevelopmentEmulator=true;
      - UserAccountApi__BaseUrl=http://user-account-api:8080
    depends_on:
      - servicebus-emulator
      - user-account-api
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  postgres_data:
  ollama_data:
  baileys_auth:
  mongodb_data:
